{"componentChunkName":"component---src-templates-template-tsx","path":"/event-logging-of-stored-process-server-sessions/","result":{"data":{"site":{"meta":{"title":"Raw SAS - SAS Tips n Tricks","description":"Tips n Tricks and other SAS Titbits from around 10 years of SAS projects and tinkering about with SAS"}},"post":{"id":"212cdc17-5255-5d6c-820f-3bf393ac849b","html":"<p>Having seemingly brought down our 9.2 Windows 2008 STP server (only in DEV!!) during development of a yet another (awesome) STP web app, it occurred to me that more information was needed about just how many requests were being batted over.<br /><hr /><br /><div style=\"color: red; font-family: 'trebuchet ms', arial, 'arial unicode ms', sans-serif; font-weight: bold;\"><img align=\"absmiddle\" alt=\"Error\" border=\"0\" src=\"http://dev-sasmidtier.partnershipassurance.int:8080/SASTheme_Partnership_Green/themes/Partnership_Green/images/MessageError24.gif\" height=\"24\" title=\"Error\" width=\"24\"> Stored Process Error</div><div style=\"font-family: 'trebuchet ms', arial, 'arial unicode ms', sans-serif; font-size: small;\"><img alt src=\"http://dev-sasmidtier.partnershipassurance.int:8080/SASTheme_Partnership_Green/themes/Partnership_Green/images/spacer.gif\" height=\"10\" title><br /><h2 style=\"font-size: medium;\">Unable to execute stored process.</h2><h2 style=\"font-size: medium;\">The server is not running (paused/deferred stop mode?).</h2></div><hr /><br />So, inspired by Quentin McMullen’s <a href=\"http://bi-notes.com/2014/02/sas_stored_process_log/\">excellent post</a>, I wanted to share my approach. <br /><br /><b>Step 1</b> was to create a table to log the events.  This was structured as follows:<br /><br /><span style=\"font-family: Courier New, Courier, monospace;\">     CREATE TABLE [dbo].[STP_LOGGER](</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">          [PROCESSED_DTTM] <a href=\"3\">datetime2</a> NOT NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\"><span style=\"white-space: pre;\"> </span>         [STATUS_CD] <a href=\"8\">char</a> NOT NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\"><span style=\"white-space: pre;\"> </span>         [_PROGRAM] [char] (500) NOT NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">          [_METAPERSON] [char] (100) NOT NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">          [SYSJOBID] [char] (12) NOT NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">          [_SESSIONID] [char] (50) NULL,</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">          [GLOB_VARS] [char] (2000) NULL</span><br /><br />Note that this table was not a SAS table (which could be subject to locking).  If you have no other choice but to use a SAS table, please refer to the previous post for attempting SAS locks (noting that this can <a href=\"http://rawsas.blogspot.co.uk/2015/03/get-physical-path-from-metadata-libref.html\">not be done via the meta engin</a>e).<br /><br /><br /><b>Step 2</b> was to create a <a href=\"https://github.com/sashub/macro/blob/master/standalone/stp_logger.sas\">macro</a> to update the table (to be placed somewhere in <a href=\"http://support.sas.com/documentation/cdl/en/hostwin/63285/HTML/default/viewer.htm#win-sysop-sasautos.htm\">SASAUTOS</a>).  Example below:<br /><br /><span style=\"font-family: Courier New, Courier, monospace;\">%macro stp<em>logger(status<em>cd= </span><span style=\"font-family: 'Courier New', Courier, monospace;\">);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  %local global</em>vars;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  proc sql noprint;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  select cats(name,’=‘,value)</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    into: global_vars</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    separated by ’|’</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    from  dictionary.macros</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    where scope = ‘GLOBAL’</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">      and substr(name,1,3) not in(‘SYS’, ‘SQL’,‘SAS’)</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">      and substr(name,1,1) ne ’</em>‘;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\"><br /></span><span style=\"font-family: Courier New, Courier, monospace;\">  %assign<em>lib(libref=web);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  proc datasets library=work; delete append; run;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  data append /view=append;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    if 0 then set web.stp<em>logger;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    PROCESSED</em>DTTM=%sysfunc(datetime());</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    STATUS<em>CD=”&#x26;status</em>cd”;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    _PROGRAM=”&#x26;_program”;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    _METAPERSON=”&#x26;_metaperson”;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    SYSJOBID=”&#x26;sysjobid”;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  %if not %symexist(_SESSIONID) %then %do;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    /</em> session id is stored in the replay variable but needs to be extracted <em>/</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    \\</em>replay=symget(’_replay’);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    _replay=subpad(_replay,index(_replay,’_sessionid=’)+11,length(_replay));</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    index=index(_replay,’&#x26;’)-1;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    if index=-1 then index=length(_replay);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    _replay=substr(_replay,1,index);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    _SESSIONID=_replay;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    drop _replay index;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  %end;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  %else %do;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    /_ explicitly created sessions are automatically available <em>/</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    \\</em>SESSIONID=symget(’_SESSIONID’);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  %end;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    GLOB<em>VARS=symget(‘global</em>vars’);</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    output;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">    stop;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  run;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\"><br /></span><span style=\"font-family: Courier New, Courier, monospace;\">  proc append base=web.stp<em>logger data=append;run;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">  proc sql; drop view append;</span><br /><span style=\"font-family: Courier New, Courier, monospace;\"><br /></span><span style=\"font-family: Courier New, Courier, monospace;\">%mend stp</em>logger;</span><br /><br /><b>Step 3</b> was to call the macro.   The quick / dirty way would be to simply include it in the SAS programs directly, but that quickly becomes unmanageable when dealing with a large number of STPs.  Another option is to include in the autoexec, but that will only deal with program ENTRY (not exit).<br />The best approach, as endorsed by <a href=\"http://bi-notes.com/2014/02/sas_stored_process_log/#comment-1955\">Don Henderson</a>, is to use the STP init and term programs.  These are straightforward .sas programs that run on an STP session’s entry and exit.  Configuration is simple, and explained here:  <a href=\"http://support.sas.com/kb/39/250.html\">http://support.sas.com/kb/39/250.html</a>.  This approach is fantastic as it will ensure that ALL calls to the STP server are logged (eg via EG, AMO, WRS, every custom web app, etc etc).   Simply add the following one-liners to each file:<br /><br /><span style=\"font-family: Courier New, Courier, monospace;\">%stp<em>logger(status</em>cd=SrvEnter)  /_ goes in the init file <em>/</span><br /><span style=\"font-family: Courier New, Courier, monospace;\">%stp</em>logger(status<em>cd=SrvExit)   /</em> goes in the term file _/</span><br /><br />Boom, we are done, and here is an extract of the new logging table:<br /><br /><div style=\"clear: both; text-align: center;\"><a href=\"/tetrahex-rawsas/45e987897554f08dfd95c1478cca7024/Capture_4.png\" style=\"margin-left: 1em; margin-right: 1em;\"><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; margin-bottom: 1.0725rem;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 43.61702127659575%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABo0lEQVQozyWRiY6jMAyGef/3ml3aaRmuUii57BAgEIYrTK/talOtFVlO8n+/LNs7Hn5Fwe6cHIHleXIIA/8c7fNzRPKEkYwVSZnH5JIe9h9x9NkqBiQjlyT82vn7Dw9QutMb83q9BBdad6qS1+t9We3z+ZznpShLLlAAEkLX1TolF8ABEMBDBIkwmP71fCBnfacbhdefbZnnx/22zBNjVKnKySgp7bp+j0OlEKXzI150yuO0uFDRDXMYZwXhWVao1oDSrZmgao5RGqV5mGTHMJW1LjlE6TnO8uRcen6Q7INTeCqF6v3P2BWHMCXQZBdBsc2p/H2IdkHqB7F/TEpRJzl1iLvuvxLPtdTWavwe/r7+1AjjYLpG/W/YZWtXBF5JbOoKgNvVPQ9Soqplp1uPCyGl1FrfbncQUNeNG4G1mzHG5XEcS0KEEIwLxtiyLK1uHcIFr+o3zEG4IevH4+H+27qtELbtZzBm2zanZpRyR1J2KYp5no3pHfKmENyqUCJ2XXe73ZxLp3WtpLXWDINd7TRNlFJwgcgYn+a577s3UklZVf8AkH/dmNCP2r4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Capture 5\" title=\"Capture 5\" src=\"/tetrahex-rawsas/static/43eeb70ea7b18f145338024ee93bd933/6af66/Capture_5.png\" srcset=\"/tetrahex-rawsas/static/43eeb70ea7b18f145338024ee93bd933/4dcb9/Capture_5.png 188w,\n/tetrahex-rawsas/static/43eeb70ea7b18f145338024ee93bd933/5ff7e/Capture_5.png 375w,\n/tetrahex-rawsas/static/43eeb70ea7b18f145338024ee93bd933/6af66/Capture_5.png 640w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span></a></div><br /><br />See that highlighted row?  A hung session with my name against it…<br /><br /><div style=\"clear: both; text-align: center;\"><a href=\"../images/2010-02-24-hangman.jpg\" style=\"margin-left: 1em; margin-right: 1em;\"><img border=\"0\" height=\"289\" src=\"http://1.bp.blogspot.com/-iq3rv-RygCQ/VenmQacknMI/AAAAAAAAAlw/uz0v7PUwxQU/s320/2010-02-24-hangman.jpg\" width=\"320\"></a></div><br /><br /><br />EDIT 13OCT2015:<i> The connection issue was finally resolved by setting the <a href=\"http://support.sas.com/rnd/itech/doc9/admin_oma/sasserver/iombridge/sp_sercl.html#sasRecycleActivationLimit\">Recycle Activation Limit</a> to 1.  This had no noticeable effect on performance.</i><br /><br /><br /><br /></p>","frontmatter":{"title":"Event Logging of Stored Process Server Sessions","path":"/event-logging-of-stored-process-server-sessions/","previewImg":null,"tags":["SQL"],"date":"Sep 04, 2015"}}},"pageContext":{"archives":{"2012":8,"2013":10,"2014":4,"2015":7,"2016":17,"2017":12,"2018":9,"2019":2,"2020":3}}},"staticQueryHashes":[]}